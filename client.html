<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>Realtime Collaborative Editor</title>

<style>
/* ================= THEME VARIABLES ================= */
:root {
  --bg: #0f111a;
  --panel: #151926;
  --panel-2: #1c2032;
  --editor: #1e2235;
  --border: #2a2f45;
  --accent: #4f8cff;
  --text: #e6e8ef;
  --muted: #9aa0b5;
}

html[data-theme="light"] {
  --bg: #f5f6fa;
  --panel: #ffffff;
  --panel-2: #f0f2f7;
  --editor: #ffffff;
  --border: #dcdfe6;
  --accent: #4f8cff;
  --text: #1f2937;
  --muted: #6b7280;
}

* {
  box-sizing: border-box;
  transition: background-color .25s, color .25s, border-color .25s;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
}

/* ================= JOIN & FILE PICKER ================= */
#joinBox, #filePicker {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--bg), var(--panel));
}

.join-card {
  background: var(--panel);
  padding: 36px;
  width: 380px;
  border-radius: 14px;
  box-shadow: 0 30px 80px rgba(0,0,0,.3);
  text-align: center;
}

.join-card h1 {
  margin: 0 0 8px;
}

.join-card p {
  margin: 0 0 20px;
  color: var(--muted);
}
/* Theme toggle always on top-right */
#themeBtnTop {
  position: fixed;
  top: 12px;
  right: 12px;
  background: var(--panel-2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 16px;
  z-index: 99999; /* ensure it's on top of joinBox and filePicker */
}


.join-card input {
  width: 100%;
  padding: 14px;
  margin-bottom: 12px;
  background: var(--editor);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
}

.join-card button {
  width: 100%;
  padding: 14px;
  margin-top: 16px;
  background: var(--accent);
  border: none;
  border-radius: 10px;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}

/* ================= APP LAYOUT ================= */
#app {
  display: none;
  height: 100%;
  width: 100%;
}

.topbar {
  height: 48px;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
}

.logo { font-weight: 700; color: var(--accent); }

.theme-toggle {
  background: var(--panel-2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 16px;
}

/* ================= MAIN LAYOUT ================= */
.main {
  display: flex;
  height: calc(100% - 48px - 28px);
}

.sidebar {
  width: 220px;
  flex-shrink: 0;
  background: var(--panel);
  border-right: 1px solid var(--border);
  padding: 12px;
}

.editor-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.tabs {
  display: flex;
  align-items: center;
  background: var(--panel-2);
  padding: 0 12px;
  gap: 8px;
  height: 40px;
  border-bottom: 1px solid var(--border);
}

.tabs .tab, #backToFiles {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  font-size: 14px;
  font-weight: 500;
  border-radius: 6px;
  cursor: pointer;
  user-select: none;
  transition: background 0.2s, color 0.2s;
}

.tabs .tab {
  background: var(--editor);
  border: 1px solid var(--border);
  color: var(--text);
  flex-shrink: 0;
}

.tabs .tab.active {
  background: var(--accent);
  color: #fff;
}

#backToFiles {
  background: var(--panel-2);
  border: 1px solid var(--border);
}

#backToFiles:hover {
  background: var(--accent);
  color: #fff;
}

.editor-controls {
  display: flex;
  gap: 8px;
  padding: 8px 12px;
}

.editor-controls button {
  border: none;
  border-radius: 8px;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s ease;
  color: #fff;
}

#startRecording { background: #10b981; }
#stopRecording { background: #ef4444; }
#replayMacro { background: #3b82f6; }

.editor-controls button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  box-shadow: none;
}

textarea#editor {
  flex: 1;
  width: 100%;
  min-width: 0;
  resize: none;
  background: var(--editor);
  border: none;
  outline: none;
  color: var(--text);
  font-family: "JetBrains Mono", Consolas, monospace;
  font-size: 15px;
  padding: 18px;
}

.log-panel {
  width: 280px;
  background: var(--panel-2);
  border-left: 1px solid var(--border);
  font-family: monospace;
  font-size: 12px;
  padding: 10px;
  overflow-y: auto;
  color: var(--muted);
}

.statusbar {
  height: 28px;
  background: var(--panel);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 12px;
  font-size: 12px;
  color: var(--muted);
}

/* ================= ACTIVE USERS ================= */
#usersList, #activeEditorsList, #filesList {
  list-style: none;
  padding: 0;
  margin: 0;
}

#usersList li, #activeEditorsList li, #filesList li {
  padding: 6px 10px;
  border-radius: 6px;
  background: var(--panel-2);
  margin-bottom: 6px;
  font-size: 13px;
}

.user-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 8px;
}

.user-indicator.online { background: #10b981; }
.user-indicator.active { background: #f59e0b; }

/* ================= RESPONSIVE ================= */
@media (max-width: 768px) {
  .main { flex-direction: column; height: auto; }
  .sidebar, .editor-area, .log-panel { width: 100%; }
  .sidebar { border-right: none; border-bottom: 1px solid var(--border); padding: 8px; display: flex; flex-wrap: wrap; gap: 8px; }
  .editor-controls, .tabs { flex-wrap: wrap; gap: 6px; }
  .log-panel { height: 150px; border-left: none; border-top: 1px solid var(--border); margin-top: 8px; }
  .topbar, .statusbar { flex-direction: column; align-items: flex-start; height: auto; gap: 4px; padding: 6px 12px; }
  textarea { padding: 12px; font-size: 14px; }
  .join-card { width: 90%; padding: 24px; }
}
</style>
</head>

<body>
<button class="theme-toggle" id="themeBtnTop">üåô</button>

<!-- JOIN -->
<div id="joinBox">
  <div class="join-card">
    <h1>Realtime Editor</h1>
    <p>Collaborate live with others</p>
    <input id="nameInput" placeholder="Enter your name" />
    <button id="joinBtn">Join Session</button>
  </div>
</div>

<!-- FILE PICKER -->
<div id="filePicker" style="display: none;">
  <div class="join-card">
    <h1>Select a file</h1>
    <ul id="filesList"></ul>
    <input id="newFile" placeholder="new-file.txt">
    <button id="createFileBtn">Create File</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="logo">Live Editor</div>
  </div>

  <div class="main">
    <aside class="sidebar">
      <h3>Online Users on full editor</h3>
      <ul id="usersList"></ul>
      <div class="active-editors">
        <h3>Active Editors on this file</h3>
        <ul id="activeEditorsList"></ul>
      </div>
    </aside>

    <section class="editor-area">
      <div class="tabs">
        <button id="backToFiles" style="display:none;">‚¨Ö Back</button>
        <div class="tab" id="fileTab">No file</div>
      </div>

      <div class="editor-controls">
        <button id="startRecording"><span>‚è∫</span> Start Recording</button>
        <button id="stopRecording" disabled><span>‚èπ</span> Stop Recording</button>
        <button id="replayMacro" disabled><span>‚ñ∂</span> Replay Macro</button>
      </div>

      <textarea id="editor" disabled spellcheck="false"></textarea>
    </section>
  </div>

  <div class="statusbar">
    <span id="status">Disconnected</span>
    <span>UTF-8 ‚Ä¢ LF</span>
  </div>
</div>

<script>
// ================= THEME TOGGLE =================
document.addEventListener("DOMContentLoaded", () => {
  const root = document.documentElement;
  const themeBtnTop = document.getElementById("themeBtnTop");

  function setTheme(theme) {
    root.setAttribute("data-theme", theme);
    themeBtnTop.textContent = theme === "dark" ? "üåô" : "‚òÄÔ∏è";
    localStorage.setItem("theme", theme);
  }
  setTheme(localStorage.getItem("theme") || "light");
  themeBtnTop.onclick = () => setTheme(root.getAttribute("data-theme")==="dark"?"light":"dark");

  // ================= ELEMENTS =================
  const joinBox = document.getElementById("joinBox");
  const nameInput = document.getElementById("nameInput");
  const joinBtn = document.getElementById("joinBtn");
  const app = document.getElementById("app");
  const filePicker = document.getElementById("filePicker");
  const filesList = document.getElementById("filesList");
  const newFile = document.getElementById("newFile");
  const createFileBtn = document.getElementById("createFileBtn");
  const editor = document.getElementById("editor");
  const backBtn = document.getElementById("backToFiles");
  const fileTab = document.getElementById("fileTab");
  const statusEl = document.getElementById("status");
  const usersList = document.getElementById("usersList");
  const activeEditorsList = document.getElementById("activeEditorsList");
  const startBtn = document.getElementById("startRecording");
  const stopBtn = document.getElementById("stopRecording");
  const replayBtn = document.getElementById("replayMacro");

  let ws, currentFile = null, localDoc = "", isApplyingRemote = false;
  let isRecording = false, recordedActions = [];

  // ================= JOIN SESSION =================
  joinBtn.onclick = () => {
    const name = nameInput.value.trim();
    if (!name) return alert("Enter your name");
    ws = new WebSocket(`ws://${location.host}`);
    ws.onopen = () => {
      ws.send(JSON.stringify({ type: "join", name }));
      statusEl.textContent = "Connected";
      joinBox.style.display = "none";
    };
    ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);

      // Users
      if (msg.type==="user-list") {
        usersList.innerHTML = "";
        msg.users.forEach(u => {
          const li = document.createElement("li");
          li.textContent = u.name + (u.editingFile?` (editing ${u.editingFile})`:"");
          usersList.appendChild(li);
        });
      }

      // Active editors
      if (msg.type==="active-editors") {
        activeEditorsList.innerHTML = "";
        msg.editors.forEach(name=>{
          const li=document.createElement("li");
          li.textContent=name;
          li.className="active-editor";
          activeEditorsList.appendChild(li);
        });
      }

      // File list
      if (msg.type==="files") {
        filesList.innerHTML="";
        msg.files.forEach(f=>{
          const li=document.createElement("li");
          li.textContent=f;
          li.onclick=()=>{ ws.send(JSON.stringify({type:"open-file",name:f})); filePicker.style.display="none"; };
          filesList.appendChild(li);
        });
        if(!currentFile) filePicker.style.display="flex";
      }

      // Open file
      if(msg.type==="init"){
        currentFile=msg.file;
        fileTab.textContent=currentFile;
        filePicker.style.display="none";
        app.style.display="block";
        editor.value=msg.doc;
        localDoc=msg.doc;
        editor.disabled=false;
        backBtn.style.display="inline-block";
      }

      // Remote updates
      if(msg.type==="op"){
        isApplyingRemote=true;
        if(msg.op==="insert") localDoc = localDoc.slice(0,msg.pos)+msg.char+localDoc.slice(msg.pos);
        else localDoc = localDoc.slice(0,msg.pos)+localDoc.slice(msg.pos+1);
        editor.value=localDoc;
        isApplyingRemote=false;
      }
    };
  };

  // ================= CREATE FILE =================
  createFileBtn.onclick=()=>{
    const name=newFile.value.trim();
    if(!name) return;
    ws.send(JSON.stringify({type:"create-file",name}));
    newFile.value="";
  };

  // ================= EDITOR INPUT =================
  editor.addEventListener("input",(e)=>{
    if(isApplyingRemote) return;
    const newText=editor.value;
    let start=0;
    while(start<localDoc.length && start<newText.length && localDoc[start]===newText[start]) start++;
    if(localDoc.length<newText.length){
      const inserted=newText.slice(start,newText.length-(localDoc.length-start));
      for(let i=0;i<inserted.length;i++){
        const action={op:"insert",pos:start+i,char:inserted[i]};
        ws.send(JSON.stringify({type:"op",...action}));
        if(isRecording) recordedActions.push(action);
      }
    } else if(localDoc.length>newText.length){
      const delCount=localDoc.length-newText.length;
      for(let i=0;i<delCount;i++){
        const action={op:"delete",pos:start};
        ws.send(JSON.stringify({type:"op",...action}));
        if(isRecording) recordedActions.push(action);
      }
    }
    localDoc=newText;
  });

  // ================= BACK TO FILES =================
  backBtn.onclick=()=>{
    app.style.display="none";
    filePicker.style.display="flex";
    currentFile=null;
    editor.value="";
    editor.disabled=true;
    backBtn.style.display="none";
  };

  // ================= RECORDING =================
  startBtn.onclick=()=>{ isRecording=true; recordedActions=[]; startBtn.disabled=true; stopBtn.disabled=false; replayBtn.disabled=true; };
  stopBtn.onclick=()=>{ isRecording=false; startBtn.disabled=false; stopBtn.disabled=true; replayBtn.disabled=recordedActions.length===0; };
  replayBtn.onclick=async()=>{
    if(!recordedActions.length) return;
    let cursorPos=editor.selectionStart;
    for(const action of recordedActions){
      if(action.op==="insert"){ localDoc = localDoc.slice(0,cursorPos)+action.char+localDoc.slice(cursorPos); cursorPos++; }
      else if(action.op==="delete" && cursorPos>0){ localDoc=localDoc.slice(0,cursorPos-1)+localDoc.slice(cursorPos); cursorPos--; }
      editor.value=localDoc;
      editor.selectionStart=editor.selectionEnd=cursorPos;
      ws.send(JSON.stringify({type:"op",op:action.op,pos:cursorPos-(action.op==="insert"?1:0),char:action.char}));
      await new Promise(r=>setTimeout(r,50));
    }
  };
});
</script>
</body>
</html>
